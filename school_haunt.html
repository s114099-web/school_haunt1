<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸æ ¡éˆç•°é€ƒè„«</title>
    <style>
        /* 1. CSS æ¨£å¼ */
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #000; /* å…¨é»‘èƒŒæ™¯ */
            color: #ccc;
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Arial', sans-serif;
            user-select: none;
        }
        canvas {
            border: 1px solid #444;
            background-color: #222;
            cursor: crosshair; /* æç¤ºç©å®¶å¯ä»¥é»æ“Š */
        }
        #info {
            margin-top: 15px;
            font-size: 1.1em;
            color: #e0e0e0;
        }
        .controls {
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .controls span {
            color: #f39c12; /* çªé¡¯æŒ‰éµ */
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>ğŸ‘» å­¸æ ¡éˆç•°é€ƒè„« ğŸ‘»</h1>
    <div class="controls">
        ç§»å‹•ï¼š<span>W A S D</span> | æ”»æ“Š/æ“Šé€€ï¼š<span>æ»‘é¼ å·¦éµé»æ“Š</span>
    </div>

    <canvas id="gameCanvas" width="800" height="560"></canvas>

    <div id="info">æ•…äº‹ï¼šä½ è¢«å›°åœ¨å»¢æ£„æ ¡åœ’ï¼Œæœ‰é¬¼é­‚åœ¨è¿½ä½ ï¼é€ƒåˆ°ç¶ è‰²å‡ºå£ï¼</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TILE_SIZE = 40; // æ¯å€‹æ–¹å¡Šçš„å¤§å°
        const PLAYER_SPEED = 3;
        const VIEW_RADIUS = TILE_SIZE * 4.5; // ç©å®¶çš„è¦–é‡ç¯„åœ

        // å­¸æ ¡åœ°åœ– (R=14, C=20)
        // 1=ç‰†å£/æ•™å®¤, 0=èµ°å»Š, 2=ç©å®¶èµ·é», 3=é¬¼é­‚èµ·é», 4=å‡ºå£(æ ¡é–€)
        const MAP = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 1], // æ ¡é–€åœ¨å³å´
            [1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], // èµ°å»Š
            [1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], // èµ°å»Š
            [1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], // èµ°å»Š
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], // èµ°å»Š
            [1, 2, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], // 2=ç©å®¶èµ·é», 3=é¬¼é­‚èµ·é»
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
        ];
        
        // å°‹æ‰¾åœ°åœ–ä¸Šçš„èµ·é»
        function findStart(type) {
            for (let r = 0; r < MAP.length; r++) {
                for (let c = 0; c < MAP[r].length; c++) {
                    if (MAP[r][c] === type) {
                        return { x: c * TILE_SIZE + TILE_SIZE / 2, y: r * TILE_SIZE + TILE_SIZE / 2 };
                    }
                }
            }
        }

        let player = {
            ...findStart(2),
            width: TILE_SIZE * 0.5,
            height: TILE_SIZE * 0.5,
            color: 'cyan'
        };

        let ghost = {
            ...findStart(3),
            width: TILE_SIZE * 0.6,
            height: TILE_SIZE * 0.6,
            speed: 2.2, // é¬¼é­‚é€Ÿåº¦
            color: 'rgba(255, 0, 0, 0.7)', // åŠé€æ˜ç´…è‰²
            isStunned: false, // æ˜¯å¦è¢«æ“Šé€€
            stunTimer: 0
        };

        let keys = {};
        let mouse = { x: 0, y: 0, clicked: false };
        let gameActive = true;
        let gameStatus = "PLAYING"; // PLAYING, WIN, LOSE

        // --- äº‹ä»¶ç›£è½å™¨ (è¼¸å…¥) ---

        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            keys[e.key] = false;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });

        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0 && gameActive) { // å·¦éµ
                mouse.clicked = true;
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 0) {
                mouse.clicked = false;
            }
        });

        // --- ç¹ªåœ–å‡½æ•¸ ---

        // ç¹ªè£½å–®å€‹åœ°åœ–æ–¹å¡Š
        function drawTile(c, r, tile) {
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            
            if (tile === 1) {
                // ç‰†å£/æ•™å®¤ (æ·±ç°è‰²ï¼Œæ¨¡æ“¬æ°´æ³¥ç‰†)
                ctx.fillStyle = '#444';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#333';
                ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
            } else if (tile === 4) {
                // å‡ºå£ (ç¶ è‰²ï¼Œæ ¡é–€)
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#2ecc71';
                ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
            } else {
                // èµ°å»Š (æ·ºç°è‰²åœ°æ¿)
                ctx.fillStyle = '#333';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
            }
        }
        
        // ç¹ªè£½æ‰€æœ‰åœ°åœ–
        function drawMap() {
            for (let r = 0; r < MAP.length; r++) {
                for (let c = 0; c < MAP[r].length; c++) {
                    drawTile(c, r, MAP[r][c]);
                }
            }
        }

        // ç¹ªè£½ç©å®¶
        function drawPlayer() {
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.width / 2, 0, Math.PI * 2);
            ctx.fill();
            
            // ç¹ªè£½æ‰‹é›»ç­’/è¦–é‡ç¯„åœ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.beginPath();
            ctx.arc(player.x, player.y, VIEW_RADIUS, 0, Math.PI * 2);
            ctx.fill();
        }

        // ç¹ªè£½é¬¼é­‚
        function drawGhost() {
            // é¬¼é­‚é–ƒçˆæ•ˆæœ
            ctx.fillStyle = ghost.isStunned ? 'rgba(255, 255, 255, 1.0)' : ghost.color;
            
            ctx.beginPath();
            // ç¹ªè£½é¬¼é­‚çš„åŠé€æ˜å½¢ç‹€
            ctx.ellipse(ghost.x, ghost.y, ghost.width / 2, ghost.height / 1.5, 0, 0, Math.PI * 2);
            ctx.fill();

            // ç¹ªè£½é¬¼è‡‰
            ctx.fillStyle = '#000';
            ctx.fillRect(ghost.x - 5, ghost.y - 5, 2, 2);
            ctx.fillRect(ghost.x + 3, ghost.y - 5, 2, 2);
        }

        // é»‘æš—é®ç½© (æ ¸å¿ƒææ€–æ•ˆæœ)
        function drawDarkness() {
            // å‰µå»ºä¸€å€‹è¦†è“‹æ•´å€‹ç•«å¸ƒçš„åœ“å½¢æ¼¸è®Š
            const gradient = ctx.createRadialGradient(
                player.x, player.y, VIEW_RADIUS * 0.5, // å…§åœˆåŠå¾‘ (è¼ƒäº®)
                player.x, player.y, VIEW_RADIUS // å¤–åœˆåŠå¾‘ (å®Œå…¨é»‘æš—)
            );
            
            // é¡è‰²å¾ä¸­é–“çš„é€æ˜ (ç©å®¶ä½ç½®) æ¼¸è®Šåˆ°å¤–éƒ¨çš„ç´”é»‘
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0.95)');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // --- éŠæˆ²é‚è¼¯å‡½æ•¸ ---

        // æª¢æŸ¥çµ¦å®šåº§æ¨™æ˜¯å¦ç‚ºç‰†å£ (1)
        function isWall(x, y) {
            const c = Math.floor(x / TILE_SIZE);
            const r = Math.floor(y / TILE_SIZE);

            if (r < 0 || r >= MAP.length || c < 0 || c >= MAP[0].length) {
                return true;
            }

            return MAP[r][c] === 1;
        }

        // æª¢æŸ¥è§’è‰²èˆ‡ç‰†å£çš„ç¢°æ’
        function checkCollision(obj, nextX, nextY) {
            const halfSize = obj.width / 2;
            const points = [
                { x: nextX - halfSize, y: nextY - halfSize }, // å·¦ä¸Š
                { x: nextX + halfSize, y: nextY - halfSize }, // å³ä¸Š
                { x: nextX - halfSize, y: nextY + halfSize }, // å·¦ä¸‹
                { x: nextX + halfSize, y: nextY + halfSize }  // å³ä¸‹
            ];

            for (const point of points) {
                if (isWall(point.x, point.y)) {
                    return true;
                }
            }
            return false;
        }
        
        // æ›´æ–°ç©å®¶ä½ç½®
        function updatePlayer() {
            let nextX = player.x;
            let nextY = player.y;

            if (keys['w'] || keys['ArrowUp']) nextY -= PLAYER_SPEED;
            if (keys['s'] || keys['ArrowDown']) nextY += PLAYER_SPEED;
            if (keys['a'] || keys['ArrowLeft']) nextX -= PLAYER_SPEED;
            if (keys['d'] || keys['ArrowRight']) nextX += PLAYER_SPEED;

            if (!checkCollision(player, nextX, player.y)) player.x = nextX;
            if (!checkCollision(player, player.x, nextY)) player.y = nextY;
            
            // æª¢æŸ¥å‹åˆ©
            const exitTile = MAP[Math.floor(player.y / TILE_SIZE)][Math.floor(player.x / TILE_SIZE)];
            if (exitTile === 4) {
                gameStatus = "WIN";
                gameActive = false;
            }
        }
        
        // æ›´æ–°é¬¼é­‚ä½ç½® (è¿½è¹¤é‚è¼¯)
        function updateGhost() {
            if (ghost.isStunned) {
                ghost.stunTimer--;
                if (ghost.stunTimer <= 0) {
                    ghost.isStunned = false;
                }
                return; // æšˆçœ©æ™‚ä¸ç§»å‹•
            }

            // è¨ˆç®—é¬¼é­‚åˆ°ç©å®¶çš„æ–¹å‘
            const dx = player.x - ghost.x;
            const dy = player.y - ghost.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance > 1) {
                const vx = (dx / distance) * ghost.speed;
                const vy = (dy / distance) * ghost.speed;

                let nextX = ghost.x + vx;
                let nextY = ghost.y + vy;

                // ç°¡æ˜“ç¢°æ’è™•ç† (é¿å…é¬¼ç©¿ç‰†ï¼Œä½†é¬¼çš„è¿½è¹¤ä¸æ‡‰è¢«ç‰†å£å®Œå…¨é˜»æ“‹)
                if (!isWall(nextX, ghost.y)) ghost.x = nextX;
                if (!isWall(ghost.x, nextY)) ghost.y = nextY;
                
                // å¦‚æœå…©å€‹æ–¹å‘éƒ½æ’ç‰†ï¼Œå‰‡å˜—è©¦ç¹é
                if (isWall(nextX, ghost.y) && isWall(ghost.x, nextY)) {
                     // è®“é¬¼é­‚éš¨æ©Ÿæ”¹è®Šæ–¹å‘ï¼Œæ¨¡æ“¬ç¹è·¯
                     if (Math.random() < 0.5) {
                         ghost.x += ghost.speed;
                     } else {
                         ghost.y += ghost.speed;
                     }
                }
            }

            // æª¢æŸ¥é¬¼é­‚èˆ‡ç©å®¶çš„æ¥è§¸ (å¤±æ•—æ¢ä»¶)
            if (distance < (player.width / 2 + ghost.width / 2) * 0.8) {
                gameStatus = "LOSE";
                gameActive = false;
            }
        }
        
        // è™•ç†æ»‘é¼ æ”»æ“Š
        function handleAttack() {
            if (mouse.clicked) {
                const distance = Math.sqrt(
                    (player.x - ghost.x) ** 2 + (player.y - ghost.y) ** 2
                );

                // æ”»æ“Šç¯„åœæª¢æŸ¥ (ä¾‹å¦‚ï¼Œåªèƒ½åœ¨ 100 åƒç´ å…§é»æ“Šåˆ°é¬¼é­‚)
                if (distance < TILE_SIZE * 2) { 
                    // é¬¼é­‚è¢«æ“Šé€€ (Stun)
                    ghost.isStunned = true;
                    ghost.stunTimer = 60; // 60 å¹€ = ç´„ 1 ç§’çš„æšˆçœ©æ™‚é–“
                    
                    // æ“Šé€€è¦–è¦ºæ•ˆæœï¼šå°‡é¬¼é­‚æ¨é›¢ç©å®¶
                    const dx = ghost.x - player.x;
                    const dy = ghost.y - player.y;
                    const angle = Math.atan2(dy, dx);
                    
                    // æ“Šé€€è·é›¢
                    ghost.x += Math.cos(angle) * TILE_SIZE * 2;
                    ghost.y += Math.sin(angle) * TILE_SIZE * 2;
                    
                    // ç¢ºä¿æ“Šé€€å¾Œé¬¼é­‚ä¸æœƒé€²å…¥ç‰†å£
                    if (isWall(ghost.x, ghost.y)) {
                        ghost.x = ghost.x - Math.cos(angle) * TILE_SIZE * 2;
                        ghost.y = ghost.y - Math.sin(angle) * TILE_SIZE * 2;
                    }
                }
            }
        }


        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½åœ°åœ–
            drawMap();
            
            if (gameActive) {
                // æ›´æ–°å’Œç¹ªè£½
                updatePlayer();
                updateGhost();
                handleAttack();
                
                drawPlayer();
                drawGhost();
                
                // é»‘æš—é®ç½©å¿…é ˆåœ¨æœ€å¾Œç¹ªè£½ï¼Œè¦†è“‹æ‰€æœ‰å…§å®¹
                drawDarkness();

            } else {
                // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                
                if (gameStatus === "WIN") {
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillText('âœ… æˆåŠŸé€ƒå‡ºæ ¡åœ’ï¼ âœ…', canvas.width / 2, canvas.height / 2);
                } else if (gameStatus === "LOSE") {
                    ctx.fillStyle = 'red';
                    ctx.fillText('ğŸ’€ ä½ è¢«é¬¼é­‚æŠ“ä½äº†... ğŸ’€', canvas.width / 2, canvas.height / 2);
                    ctx.font = '24px Arial';
                    ctx.fillText('åˆ·æ–°é é¢é‡æ–°é–‹å§‹', canvas.width / 2, canvas.height / 2 + 50);
                }
            }

            // å¾ªç’°èª¿ç”¨
            requestAnimationFrame(gameLoop);
        }

        // å•Ÿå‹•éŠæˆ²
        gameLoop();
    </script>

</body>
</html>